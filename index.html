<!DOCTYPE html>
<html>
  <meta charset="utf-8" />
  <title>Hospitalisierungsrate</title>
  <div
    id="container"
    style="position: absolute; left: 0; top: 0; right: 0; bottom: 0"
  ></div>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script>
    function pad(n) {
      return n < 10 ? `0${n}` : n;
    }
    function getLine(data, stateLong, stateShort, visible = false) {
      return {
        type: "line",
        name: stateShort,
        data: data
          .filter(({ state, age }) => state === stateLong && age === "00+")
          .map(({ date, incidence }) => ({
            name: `${pad(date.getUTCDate())}.${pad(
              date.getUTCMonth() + 1
            )}.${date.getUTCFullYear()}`,
            x: date,
            y: incidence,
          })),
        visible,
      };
    }
    document.addEventListener("DOMContentLoaded", async function () {
      const response = await fetch(
        "https://raw.githubusercontent.com/robert-koch-institut/COVID-19-Hospitalisierungen_in_Deutschland/master/Aktuell_Deutschland_COVID-19-Hospitalisierungen.csv"
      );
      const text = await response.text();
      const data = text
        .split("\n")
        .filter((_, i) => i > 0)
        .map((r) => r.split(","))
        .map(([date, state, stateId, age, count, incidence]) => ({
          date: new Date(date),
          state,
          age,
          incidence: Number(incidence),
        }))
        .sort((a, b) => (a.date === b.date ? 0 : a.date < b.date ? -1 : 1));

      const chart = Highcharts.chart("container", {
        xAxis: {
          type: "datetime",
          tickInterval: 7 * 24 * 3600 * 1000,
        },
        yAxis: {
          tickInterval: 3,
          title: {
            enabled: false,
          },
          plotBands: [
            {
              color: "hsl(30, 0%, 94%)",
              from: 0,
              to: 3,
              label: {
                text: "3G",
                align: "right",
                x: -10,
              },
            },
            {
              color: "hsl(30, 0%, 84%)",
              from: 3,
              to: 6,
              label: {
                text: "2G",
                align: "right",
                x: -10,
              },
            },
            {
              color: "hsl(30, 0%, 74%)",
              from: 6,
              to: 9,
              label: {
                text: "2G+",
                align: "right",
                x: -10,
              },
            },
            {
              color: "hsl(30, 0%, 64%)",
              from: 9,
              to: 99,
              label: {
                text: "Weitere Maßnahmen",
                align: "right",
                x: -10,
              },
            },
          ],
        },
        series: [
          getLine(data, "Bundesgebiet", "Deutschland", true),
          getLine(data, "Nordrhein-Westfalen", "NRW", true),
          getLine(data, "Baden-Württemberg", "BW"),
          getLine(data, "Bayern", "BY"),
          getLine(data, "Berlin", "BE"),
          getLine(data, "Brandenburg", "BB"),
          getLine(data, "Bremen", "HB"),
          getLine(data, "Hamburg", "HH"),
          getLine(data, "Hessen", "HE"),
          getLine(data, "Mecklenburg-Vorpommern", "MV"),
          getLine(data, "Niedersachsen", "NI"),
          getLine(data, "Rheinland-Pfalz", "RP"),
          getLine(data, "Saarland", "SL"),
          getLine(data, "Sachsen", "SN"),
          getLine(data, "Sachsen-Anhalt", "ST"),
          getLine(data, "Schleswig-Holstein", "SH"),
          getLine(data, "Thüringen", "TH"),
        ],
        title: {
          text: "Hospitalisierungsrate",
        },
      });
    });
  </script>
</html>
